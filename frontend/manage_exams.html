<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Exams</title>
  <link rel="stylesheet" href="css/invigilator.css" />
</head>
<body>
<nav class="nav-bar">
  <h1>üìã Manage Exams</h1>
  <div class="nav-buttons">
    <!-- Make sure these paths point to the actual HTML file in your frontend folder -->
    <button onclick="window.location.href='invigilator.html'" class="btn-nav">üè† Dashboard</button>
    <button onclick="window.location.href='students.html'" class="btn-nav">üë• Students</button>
    <span id="username"></span>
    <button onclick="logout()" class="btn-logout">Logout</button>
  </div>
</nav>

<div class="dashboard-container">
  <section class="exam-section">
    <h2>My Created Exams</h2>
    <div id="examsList" class="exam-list">
      <p class="placeholder">Loading exams...</p>
    </div>
  </section>
</div>

<script>
const API_BASE = "http://localhost:8000"; // change to your backend host if different

window.onload = async () => {
  const token = localStorage.getItem('token');
  const role = (localStorage.getItem('role') || '').toLowerCase();
  const username = localStorage.getItem('username') || '';

  if (!token || role !== 'invigilator') {
    window.location.href = 'login.html';
    return;
  }

  document.getElementById('username').textContent = username;
  await loadMyExams();
};

function logout() {
  localStorage.clear();
  window.location.href = 'login.html';
}

async function loadMyExams() {
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE}/exam/my`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) throw new Error('Failed to fetch your exams');

    const exams = await res.json();
    const list = document.getElementById('examsList');
    list.innerHTML = '';

    if (!exams.length) {
      list.innerHTML = '<p class="placeholder">No exams found.</p>';
      return;
    }

    exams.forEach(exam => {
      const createdAt = new Date(exam.created_at).toLocaleString();
      const div = document.createElement('div');
      div.className = 'exam-item';
      div.innerHTML = `
        <div>
          <strong>${exam.title}</strong>
          <p>${exam.description || ''}</p>
          <p><small>Created at: ${createdAt}</small></p>
        </div>
        <div>
          <button onclick="deleteExam(${exam.id})" class="btn-delete">üóë Delete</button>
        </div>
      `;
      list.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    document.getElementById('examsList').innerHTML = '<p class="placeholder">Error loading exams</p>';
  }
}

async function deleteExam(examId) {
  if (!confirm("Are you sure you want to delete this exam? This action cannot be undone.")) return;

  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_BASE}/exam/${examId}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) {
      const errData = await res.json();
      throw new Error(errData.detail || 'Failed to delete exam');
    }

    alert("‚úÖ Exam deleted successfully");
    await loadMyExams();

    // Optional: Also update stats in dashboard if present
    const statsCounter = document.getElementById('totalExamsCreated');
    if (statsCounter) {
      const myExamsRes = await fetch(`${API_BASE}/exam/my`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (myExamsRes.ok) {
        const myExams = await myExamsRes.json();
        statsCounter.textContent = myExams.length;
      }
    }

  } catch (err) {
    console.error(err);
    alert("‚ùå " + err.message);
  }
}
</script>
</body>
</html>
